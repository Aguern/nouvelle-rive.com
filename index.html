<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mariage Marine & Nicolas</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Karla:ital,wght@1,400&display=swap');

    body {
      font-family: 'Karla', sans-serif;
      background-color: #f7f7fc;
      color: #333;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    .banner {
      width: 100vw;
      max-height: 300px;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      object-position: center;
      display: block;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 2rem;
      color: #333;
    }

    h2 {
      font-size: 1.2rem;
      color: #818edb;
      margin-top: 0.5rem;
    }

    p {
      margin: 1rem 0;
    }

    .btn-share-site {
      background-color: transparent;
      color: #818edb;
      border: 1px solid #818edb;
      padding: 0.8rem 1.5rem;
      border-radius: 25px;
      font-size: 0.9rem;
      cursor: pointer;
      margin: 1.5rem 0 2rem 0;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .btn-share-site:hover {
      background-color: #818edb;
      color: white;
    }

    .btn-share-site svg {
      width: 16px;
      height: 16px;
    }

    .btn-fixed {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #818edb;
      color: white;
      padding: 1rem 2rem;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .btn-fixed:hover {
      background-color: #6f7ac7;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 20px;
      text-align: center;
      width: calc(90% - 2rem);
      max-width: 400px;
      margin: 1rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .modal-buttons button {
      margin: 0;
      padding: 1.2rem 2rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      transition: all 0.2s;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .public-btn {
      background-color: #818edb;
      color: white;
    }

    .public-btn:hover {
      background-color: #6f7ac7;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(129, 142, 219, 0.4);
    }

    .private-btn {
      background-color: #f0f0f0;
      color: #333;
    }

    .private-btn:hover {
      background-color: #e0e0e0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Loader */
    .loader {
      display: none;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #818edb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #gallery {
      margin-top: 3rem;
    }

    /* Galerie √† marges fines et vignettes plein cadre */
    #drive-gallery {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
      padding: 1rem 0;
      max-width: 900px;
      margin: auto;
    }

    #drive-gallery > div {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 100%;
      background: black;
      overflow: hidden;
    }

    #drive-gallery img,
    #drive-gallery video {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
    }

    @media (min-width: 768px) {
      #drive-gallery {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    input[type='file'] {
      display: none;
    }

    .lightbox {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .lightbox-content {
      max-width: 90%;
      max-height: 80vh;
    }

    .lightbox img,
    .lightbox video,
    .lightbox iframe {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 0;
    }

    /* Croix de fermeture */
    .lightbox .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 2rem;
      color: white;
      line-height: 1;
      cursor: pointer;
      z-index: 1002;
    }

    /* Bouton t√©l√©chargement en haut √† gauche */
    .download-btn {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: none;
      border: none;
      z-index: 1001;
    }

    .download-btn img {
      width: 28px;
      height: 28px;
      filter: invert(1);
    }

    /* Navigation dans la lightbox */
    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 2.5rem;
      padding: 1rem 1.5rem;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.2s;
      z-index: 1001;
    }

    .lightbox-nav:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .lightbox-nav.prev {
      left: 1rem;
    }

    .lightbox-nav.next {
      right: 1rem;
    }

    body.lightbox-open .btn-fixed {
      display: none !important;
    }
  </style>
</head>
<body>

  <header>
    <img src="header.png" class="banner" alt="banni√®re"/>
  </header>

  <h1>Mariage Marine et Nicolas</h1>
  <h2>19 juillet 2025</h2>
  <p>N'h√©sitez pas √† nous partager vos photos ou vid√©os<br />afin de nous laisser un souvenir de cette journ√©e si sp√©ciale.</p>
  
  <button class="btn-share-site" onclick="shareSite()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
      <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
    </svg>
    Partager ce site
  </button>

  <button class="btn-fixed" onclick="openMediaSelector()">Partager mon souvenir</button>
  
  <!-- Input simplifi√© pour tous les appareils avec s√©lection multiple -->
  <input id="mediaInput" type="file" accept="image/*,video/*" multiple onchange="handleFiles(this.files)" />

  <div id="popup" class="modal">
    <div class="modal-content">
      <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">Souhaitez-vous afficher ce m√©dia dans la galerie ?</p>
      <div class="loader" id="loader"></div>
      <div class="modal-buttons" id="modalButtons">
        <button class="public-btn" onclick="sendMedia(true)">üì¢ Afficher en public</button>
        <button class="private-btn" onclick="sendMedia(false)">üîí Uniquement pour les mari√©s</button>
      </div>
    </div>
  </div>

  <div id="gallery">
    <h2>Galerie des invit√©s</h2>
    <div id="drive-gallery"></div>
  </div>

  <div class="lightbox" id="lightbox" onclick="closeLightbox(event)">
    <div id="lightbox-content"></div>
    <button class="close-btn" onclick="closeLightbox({target:document.getElementById('lightbox')});">&times;</button>
    <button class="download-btn" id="downloadBtn" onclick="downloadMedia()">
      <img src="telecharger-un-fichier.png" alt="T√©l√©charger"/>
    </button>
    <button class="lightbox-nav prev" onclick="navigateGallery(-1)">‚Äπ</button>
    <button class="lightbox-nav next" onclick="navigateGallery(1)">‚Ä∫</button>
  </div>




  <script>
    const GAS_URL   = "https://script.google.com/macros/s/AKfycbyrHYsPR1vE3nnVU3kcs8Tf31YbPf_yckdrHS9-QqE75SEcdHQ6LD8h96mkTRj6C_lP/exec";
    const DRIVE_PUBLIC_FOLDER  = "1J4fn2yvUhe0MEZY6KZtDb_2PJutP7FL7";
    const DRIVE_PRIVATE_FOLDER = "1zJEwPT2cFRyB7OzgAgvQSMNZCnWvRDf_"; 
    const folderId = DRIVE_PUBLIC_FOLDER; // un seul endroit √† maintenir
    const apiKey = "AIzaSyAKdgvWZ4dX7oS0btyCHtMSS-bgErTtnhY";

    // R√©cup√®re un jeton OAuth Drive (validit√© ~1 h)
    async function getDriveToken() {
      const res = await fetch(`${GAS_URL}?action=token`);
      if (!res.ok) throw new Error('Impossible de r√©cup√©rer le jeton');
      const { token } = await res.json();
      return token;
    }


    let galleryFiles = [];
    let currentImageIndex = 0;

    async function loadGallery() {
      const endpoint = `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+(mimeType+contains+'image/'+or+mimeType+contains+'video/')&key=${apiKey}&fields=files(id,name,mimeType,thumbnailLink,webContentLink)`;
      const res = await fetch(endpoint);
      const data = await res.json();
      const container = document.getElementById("drive-gallery");

      galleryFiles = data.files;
      container.innerHTML = "";
      
      data.files.forEach((file, index) => {
        const thumb = file.thumbnailLink?.replace("=s220", "=s2000") || ""; // CORRECTION 1: Qualit√© am√©lior√©e
        const webLink = file.webContentLink;

        const wrapper = document.createElement("div");
        const element = file.mimeType.includes("video")
          ? document.createElement("video")
          : document.createElement("img");

        if (file.mimeType.includes("video")) {
          element.src = `https://drive.google.com/uc?export=download&id=${file.id}`;
          element.setAttribute("playsinline", "");
          element.setAttribute("muted", "");
          element.setAttribute("preload", "metadata");
          element.setAttribute("poster", thumb);
        } else {
          // CORRECTION 2: Utiliser l'image haute qualit√© pour l'affichage
          element.src = `https://drive.google.com/uc?export=view&id=${file.id}`;
          // Fallback sur thumbnail en cas d'erreur
          element.onerror = function() {
            this.src = thumb;
          };
        }
        
        element.alt = file.name;
        element.setAttribute("data-full", webLink);
        element.onclick = () => openLightbox(file.mimeType, element.src, webLink, index);

        wrapper.appendChild(element);
        container.appendChild(wrapper);
      });
    }

    function openLightbox(type, src, downloadLink, index) {
      currentImageIndex = index;
      const content = document.getElementById("lightbox-content");
      const lightbox = document.getElementById("lightbox");
      const btn = document.getElementById("downloadBtn");

      content.innerHTML = "";

      if (type.includes("video")) {
        // Utiliser une iframe pour les vid√©os Google Drive
        const fileId = galleryFiles[index].id;
        const iframe = document.createElement("iframe");
        iframe.src = `https://drive.google.com/file/d/${fileId}/preview`;
        iframe.style.width = "100%";
        iframe.style.height = "80vh";
        iframe.style.border = "none";
        iframe.setAttribute("allowfullscreen", "");
        iframe.setAttribute("allow", "autoplay");
        
        content.appendChild(iframe);
      } else {
        const el = document.createElement("img");
        const fileId = galleryFiles[index].id;
        // CORRECTION 3: Image haute qualit√© dans la lightbox
        el.src = `https://drive.google.com/uc?export=view&id=${fileId}`;
        
        // Fallback en cas d'erreur
        el.onerror = function() {
          const thumb = galleryFiles[index].thumbnailLink?.replace("=s220", "=s2000") || "";
          this.src = thumb;
        };
        
        content.appendChild(el);
      }

      btn.setAttribute("data-src", downloadLink);
      document.body.classList.add("lightbox-open");
      lightbox.style.display = "flex";
      
      updateNavigationButtons();
    }

    function navigateGallery(direction) {
      currentImageIndex += direction;
      
      if (currentImageIndex < 0) currentImageIndex = galleryFiles.length - 1;
      if (currentImageIndex >= galleryFiles.length) currentImageIndex = 0;
      
      const file = galleryFiles[currentImageIndex];
      const thumb = file.thumbnailLink?.replace("=s220", "=s600") || "";
      const src = file.mimeType.includes("video")
        ? `https://drive.google.com/uc?export=download&id=${file.id}`
        : thumb;
      
      openLightbox(file.mimeType, src, file.webContentLink, currentImageIndex);
    }

    function updateNavigationButtons() {
      const prevBtn = document.querySelector('.lightbox-nav.prev');
      const nextBtn = document.querySelector('.lightbox-nav.next');
      
      prevBtn.style.display = galleryFiles.length > 1 ? 'block' : 'none';
      nextBtn.style.display = galleryFiles.length > 1 ? 'block' : 'none';
    }

    function downloadMedia() {
      const src = document.getElementById("downloadBtn").getAttribute("data-src");
      
      // Cr√©er un lien de t√©l√©chargement et le d√©clencher
      const a = document.createElement("a");
      a.href = src;
      a.download = galleryFiles[currentImageIndex].name || "media";
      a.target = "_blank";
      
      // Ajouter temporairement le lien au DOM
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function closeLightbox(event) {
      if (event.target.id === "lightbox" || event.key === "Escape" || event.target.classList.contains('close-btn')) {
        document.getElementById("lightbox").style.display = "none";
        document.body.classList.remove("lightbox-open");
      }
    }

    document.addEventListener("keydown", closeLightbox);
    window.addEventListener("DOMContentLoaded", loadGallery);

    // Fonction simplifi√©e pour ouvrir le s√©lecteur de m√©dia
    function openMediaSelector() {
      // Ouvrir directement l'input sur tous les appareils
      document.getElementById('mediaInput').click();
    }

    // Fonction de partage du site
    async function shareSite() {
      const shareData = {
        title: 'Mariage Marine & Nicolas',
        text: 'Venez partager vos souvenirs du mariage de Marine & Nicolas ! üì∏üíï',
        url: window.location.href
      };

      try {
        // V√©rifier si l'API Web Share est support√©e
        if (navigator.share) {
          await navigator.share(shareData);
        } else {
          // Fallback : copier le lien et afficher un message
          await navigator.clipboard.writeText(window.location.href);
          alert('Lien copi√© dans le presse-papiers !\n\nVous pouvez maintenant le partager via WhatsApp, SMS ou email.');
        }
      } catch (err) {
        // En cas d'erreur ou d'annulation, proposer la copie du lien
        if (err.name !== 'AbortError') {
          try {
            await navigator.clipboard.writeText(window.location.href);
            alert('Lien copi√© dans le presse-papiers !');
          } catch (clipboardErr) {
            // Fallback ultime si m√™me le clipboard ne fonctionne pas
            prompt('Copiez ce lien pour le partager :', window.location.href);
          }
        }
      }
    }

    let selectedFiles = [];
    
    // Fonction pour g√©rer la s√©lection multiple avec aper√ßu
    function handleFiles(files) {
      if (files && files.length > 0) {
        selectedFiles = Array.from(files);
        
        // Afficher l'aper√ßu des fichiers s√©lectionn√©s
        showFilePreview(selectedFiles);
      }
    }
    
    // Fonction pour afficher l'aper√ßu des fichiers s√©lectionn√©s
    function showFilePreview(files) {
      const modalContent = document.querySelector('.modal-content');
      const fileCount = files.length;
      
      // G√©n√©rer l'aper√ßu des fichiers
      let filePreviewHtml = '';
      files.forEach((file, index) => {
        const fileType = file.type.includes('video') ? 'üé•' : 'üì∑';
        const fileName = file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name;
        filePreviewHtml += `
          <div style="display: flex; align-items: center; padding: 0.5rem; margin: 0.25rem 0; background: #f8f9fa; border-radius: 8px;">
            <span style="font-size: 1.2rem; margin-right: 0.5rem;">${fileType}</span>
            <span style="font-size: 0.9rem; color: #666;">${fileName}</span>
          </div>
        `;
      });
      
      // Texte adapt√© au nombre de fichiers
      const fileTypes = files.map(f => f.type.includes('video') ? 'vid√©o' : 'photo');
      const hasVideos = fileTypes.includes('vid√©o');
      const hasPhotos = fileTypes.includes('photo');
      
      let typeText = '';
      if (hasVideos && hasPhotos) {
        typeText = `${fileCount} m√©dias`;
      } else if (hasVideos) {
        typeText = fileCount === 1 ? '1 vid√©o' : `${fileCount} vid√©os`;
      } else {
        typeText = fileCount === 1 ? '1 photo' : `${fileCount} photos`;
      }
      
      modalContent.innerHTML = `
        <div style="padding: 1.5rem;">
          <h3 style="margin-bottom: 1rem; color: #333;">Envoyer ${typeText} ?</h3>
          <div style="max-height: 200px; overflow-y: auto; margin-bottom: 1.5rem;">
            ${filePreviewHtml}
          </div>
          <p style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">
            ${fileCount === 1 ? 'Ce fichier sera' : 'Ces fichiers seront'} ajout√©s √† la galerie publique.
          </p>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <button onclick="confirmUpload(true)" style="
              background-color: #818edb; color: white; border: none; padding: 1rem 1.5rem; 
              border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem;
              transition: all 0.2s;
            " onmouseover="this.style.backgroundColor='#6f7ac7'" onmouseout="this.style.backgroundColor='#818edb'">
              üì¢ Envoyer ${typeText}
            </button>
            <button onclick="cancelUpload()" style="
              background-color: #f0f0f0; color: #666; border: none; padding: 0.8rem 1.5rem; 
              border-radius: 12px; cursor: pointer; font-size: 0.9rem;
            " onmouseover="this.style.backgroundColor='#e0e0e0'" onmouseout="this.style.backgroundColor='#f0f0f0'">
              Annuler
            </button>
          </div>
        </div>
      `;
      
      // Afficher la modal
      document.getElementById('popup').style.display = 'flex';
    }
    
    // Fonction pour confirmer l'upload
    function confirmUpload(isPublic) {
      // CORRECTION: V√©rifier la limite AVANT d'afficher le succ√®s
      if (selectedFiles.length > 10) {
        showDiscretError('Maximum 10 fichiers √† la fois. S√©lectionnez moins de fichiers.');
        return; // Arr√™ter ici, ne pas continuer
      }
      
      const modalContent = document.querySelector('.modal-content');
      const fileCount = selectedFiles.length;
      
      // Feedback imm√©diat de succ√®s (SEULEMENT si <= 10 fichiers)
      modalContent.innerHTML = `
        <div style="padding: 2rem;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üéâ</div>
          <h3 style="color: #4CAF50; margin-bottom: 1rem;">Merci !</h3>
          <p style="font-size: 1.1rem;">
            ${fileCount === 1 ? 'Votre fichier a √©t√© re√ßu' : `Vos ${fileCount} fichiers ont √©t√© re√ßus`} ! 
            ${fileCount === 1 ? 'Il' : 'Ils'} seront trait√©s dans quelques instants.
          </p>
          <p style="font-size: 0.9rem; color: #666; margin-top: 1rem;">
            Vous pouvez continuer √† utiliser le site normalement.
          </p>
        </div>
      `;
      
      // Fermer automatiquement apr√®s 3 secondes
      setTimeout(() => {
        document.getElementById('popup').style.display = 'none';
        resetModal();
      }, 3000);
      
      // Upload en arri√®re-plan
      uploadMultipleFilesInBackground(selectedFiles, isPublic);
      
      // R√©initialiser la s√©lection
      selectedFiles = [];
      document.getElementById('mediaInput').value = '';
    }
    
    // Fonction pour annuler l'upload
    function cancelUpload() {
      document.getElementById('popup').style.display = 'none';
      resetModal();
      
      // R√©initialiser la s√©lection
      selectedFiles = [];
      document.getElementById('mediaInput').value = '';
    }
    
    // Fonction pour r√©initialiser la modal
    function resetModal() {
      const modalContent = document.querySelector('.modal-content');
      modalContent.innerHTML = `
        <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">Souhaitez-vous afficher ce m√©dia dans la galerie ?</p>
        <div class="loader" id="loader"></div>
        <div class="modal-buttons" id="modalButtons">
          <button class="public-btn" onclick="sendMedia(true)">üì¢ Afficher en public</button>
          <button class="private-btn" onclick="sendMedia(false)">üîí Uniquement pour les mari√©s</button>
        </div>
      `;
    }
    
    // Fonction de compatibilit√© pour l'upload simple
    function handleFile(file) {
      if (file) {
        handleFiles([file]);
      }
    }

    // Variables pour la gestion de la charge
    let uploadQueue = [];
    let activeUploads = 0;
    const MAX_CONCURRENT_UPLOADS = 3; // Limitation pour √©viter la surcharge
    const MAX_RETRY_ATTEMPTS = 5;

    // Fonction pour uploader plusieurs fichiers avec gestion de charge am√©lior√©e
    async function uploadMultipleFilesInBackground(files, isPublic) {
      console.log(`üöÄ Ajout de ${files.length} fichier(s) √† la queue d'upload`);
      
      // CORRECTION: La v√©rification de limite est maintenant dans confirmUpload()
      // Cette fonction ne re√ßoit que des fichiers valid√©s
      
      // Ajouter les fichiers √† la queue
      files.forEach(file => {
        uploadQueue.push({
          file: file,
          isPublic: isPublic,
          attempts: 0,
          id: Date.now() + Math.random() // ID unique
        });
      });
      
      // D√©marrer le traitement de la queue
      processUploadQueue();
    }
    

    /** 
     * Upload Drive r√©sumable (chunk 8 MiB)
     * @param {File} file     ‚Äì fichier du navigateur
     * @param {string} token  ‚Äì ya29.‚Ä¶ (Bearer)
     * @param {boolean} pub   ‚Äì true = dossier public, false = dossier priv√©
     */
    async function resumableUpload(file, token, pub) {
      const CHUNK = 8 * 1024 * 1024; // 8 MiB
      const metadata = {
        name: file.name,
        mimeType: file.type || 'application/octet-stream',
        parents: [ pub ? DRIVE_PUBLIC_FOLDER : DRIVE_PRIVATE_FOLDER ]
      };

      /* 1Ô∏è‚É£  Cr√©e la session */
      const initRes = await fetch(
        "https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable",
        {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json; charset=UTF-8",
            "X-Upload-Content-Length": file.size,
            "X-Upload-Content-Type": file.type
          },
          body: JSON.stringify(metadata)
        }
      );
      if (!initRes.ok)
        throw new Error("Init upload: " + (await initRes.text()));
      const sessionURL = initRes.headers.get("Location");

      /* 2Ô∏è‚É£  Envoie le fichier par morceaux */
      let start = 0;
      while (start < file.size) {
        const end   = Math.min(start + CHUNK, file.size);
        const chunk = file.slice(start, end);

        const uploadRes = await fetch(sessionURL, {
          method: "PUT",
          headers: {
            "Content-Range": `bytes ${start}-${end - 1}/${file.size}`
          },
          body: chunk
        });

        if (![200, 201, 308].includes(uploadRes.status))
          throw new Error("Chunk failed: " + (await uploadRes.text()));

        start = end; // prochain morceau
      }
    }

    // Fonction pour traiter la queue d'upload
    async function processUploadQueue() {
      while (uploadQueue.length > 0 && activeUploads < MAX_CONCURRENT_UPLOADS) {
        const uploadTask = uploadQueue.shift();
        if (uploadTask) {
          activeUploads++;
          uploadFileWithRetry(uploadTask).finally(() => {
            activeUploads--;
            // Continuer le traitement de la queue
            if (uploadQueue.length > 0) {
              setTimeout(() => processUploadQueue(), 200); // Petite pause entre uploads
            } else if (activeUploads === 0) {
              // Tous les uploads termin√©s
              console.log('‚úÖ Tous les uploads termin√©s');
              setTimeout(() => loadGallery(), 1500); // Recharger la galerie
            }
          });
        }
      }
    }
    
    // Fonction d'upload avec retry automatique
    async function uploadFileWithRetry(uploadTask) {
      const { file, isPublic, attempts, id } = uploadTask;
      
      try {
        console.log(`üì§ Upload ${file.name} (tentative ${attempts + 1}/${MAX_RETRY_ATTEMPTS})`);
        const token = await getDriveToken();               
        await resumableUpload(file, token, isPublic);
        console.log(`‚úÖ Upload r√©ussi: ${file.name}`);
        
      } catch (error) {
        console.error(`‚ùå √âchec upload ${file.name}:`, error);
        
        // Retry automatique si pas trop de tentatives
        if (attempts < MAX_RETRY_ATTEMPTS - 1) {
          console.log(`üîÑ Retry ${file.name} dans 2 secondes...`);
          uploadTask.attempts++;
          
          // Remettre en queue avec d√©lai
          setTimeout(() => {
            uploadQueue.unshift(uploadTask); // Priorit√© aux retry
            processUploadQueue();
          }, 2000 + (attempts * 1000)); // D√©lai croissant
          
        } else {
          // √âchec d√©finitif apr√®s tous les retry
          showDiscretError(`√âchec d√©finitif: ${file.name}`);
        }
      }
    }

    // Fonction pour afficher une erreur discr√®te
    function showDiscretError(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: #f44336;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 25px;
        font-size: 0.9rem;
        z-index: 1001;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.3s ease;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Animation d'apparition
      setTimeout(() => notification.style.opacity = '1', 100);
      
      // Supprimer apr√®s 4 secondes
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 4000);
    }

    async function sendMedia(isPublic) {
      // Cette fonction n'est plus utilis√©e car le feedback est imm√©diat dans handleFiles()
      console.log('sendMedia appel√©e, mais upload d√©j√† fait en arri√®re-plan');
    }

  </script>

</body>
</html>
