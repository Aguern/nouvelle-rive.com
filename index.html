<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mariage Marine & Nicolas</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Karla:ital,wght@1,400&display=swap');

    body {
      font-family: 'Karla', sans-serif;
      background-color: #f7f7fc;
      color: #333;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    .banner {
      width: 100vw;
      max-height: 300px;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      object-position: center;
      display: block;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 2rem;
      color: #333;
    }

    h2 {
      font-size: 1.2rem;
      color: #818edb;
      margin-top: 0.5rem;
    }

    p {
      margin: 1rem 0;
    }

    .btn-fixed {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #818edb;
      color: white;
      padding: 1rem 2rem;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .btn-fixed:hover {
      background-color: #6f7ac7;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 20px;
      text-align: center;
      width: calc(90% - 2rem);
      max-width: 400px;
      margin: 1rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .modal-buttons button {
      margin: 0;
      padding: 1.2rem 2rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      transition: all 0.2s;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .public-btn {
      background-color: #818edb;
      color: white;
    }

    .public-btn:hover {
      background-color: #6f7ac7;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(129, 142, 219, 0.4);
    }

    .private-btn {
      background-color: #f0f0f0;
      color: #333;
    }

    .private-btn:hover {
      background-color: #e0e0e0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Loader */
    .loader {
      display: none;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #818edb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #gallery {
      margin-top: 3rem;
    }

    /* Galerie √† marges fines et vignettes plein cadre */
    #drive-gallery {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
      padding: 1rem 0;
      max-width: 900px;
      margin: auto;
    }

    #drive-gallery > div {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 100%;
      background: black;
      overflow: hidden;
    }

    #drive-gallery img,
    #drive-gallery video {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
    }

    @media (min-width: 768px) {
      #drive-gallery {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    input[type='file'] {
      display: none;
    }

    .lightbox {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .lightbox-content {
      max-width: 90%;
      max-height: 80vh;
    }

    .lightbox img,
    .lightbox video {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 0;
    }

    /* Croix de fermeture */
    .lightbox .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 2rem;
      color: white;
      line-height: 1;
      cursor: pointer;
      z-index: 1002;
    }

    /* Bouton t√©l√©chargement en haut √† gauche */
    .download-btn {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: none;
      border: none;
      z-index: 1001;
    }

    .download-btn img {
      width: 28px;
      height: 28px;
      filter: invert(1);
    }

    /* Navigation dans la lightbox */
    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 2.5rem;
      padding: 1rem 1.5rem;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.2s;
      z-index: 1001;
    }

    .lightbox-nav:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .lightbox-nav.prev {
      left: 1rem;
    }

    .lightbox-nav.next {
      right: 1rem;
    }

    body.lightbox-open .btn-fixed {
      display: none !important;
    }

    /* Styles pour le menu de s√©lection photo/cam√©ra */
    .source-selection {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      padding: 1rem;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      z-index: 1100;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    .source-selection-option {
      display: flex;
      align-items: center;
      padding: 1rem;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 1.1rem;
      color: #333;
      border-radius: 10px;
      transition: background-color 0.2s;
    }

    .source-selection-option:hover,
    .source-selection-option:active {
      background-color: #f0f0f0;
    }

    .source-selection-option svg {
      width: 24px;
      height: 24px;
      margin-right: 1rem;
      fill: #818edb;
    }

    .source-selection-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1099;
    }

    .source-selection-cancel {
      margin-top: 0.5rem;
      padding: 1rem;
      width: 100%;
      border: none;
      background: #f0f0f0;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      color: #666;
    }
  </style>
</head>
<body>

  <header>
    <img src="header.png" class="banner" alt="banni√®re"/>
  </header>

  <h1>Mariage Marine et Nicolas</h1>
  <h2>19 juillet 2025</h2>
  <p>N'h√©sitez pas √† nous partager vos photos ou vid√©os<br />afin de nous laisser un souvenir de cette journ√©e si sp√©ciale.</p>

  <button class="btn-fixed" onclick="openMediaSelector()">Partager mon souvenir</button>
  
  <!-- Inputs pour diff√©rents cas -->
  <input id="mediaInput" type="file" accept="image/*,video/*" onchange="handleFile(this.files[0])" />
  <input id="cameraInput" type="file" accept="image/*,video/*" capture="environment" onchange="handleFile(this.files[0])" />
  
  <!-- Menu de s√©lection pour Android uniquement -->
  <div class="source-selection-backdrop" onclick="hideSourceSelection()"></div>
  <div class="source-selection" id="sourceSelection">
    <button class="source-selection-option" onclick="selectCamera()">
      <svg viewBox="0 0 24 24">
        <path d="M12 15.2c-1.8 0-3.2-1.4-3.2-3.2s1.4-3.2 3.2-3.2 3.2 1.4 3.2 3.2-1.4 3.2-3.2 3.2zm9-11.2h-3.2l-1.8-2h-8l-1.8 2h-3.2c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2v-12c0-1.1-.9-2-2-2zm-9 13c-2.8 0-5-2.2-5-5s2.2-5 5-5 5 2.2 5 5-2.2 5-5 5z"/>
      </svg>
      Cam√©ra
    </button>
    <button class="source-selection-option" onclick="selectGallery()">
      <svg viewBox="0 0 24 24">
        <path d="M21 19v-14c0-1.1-.9-2-2-2h-14c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-12.5-5.5l2.5 3.01 3.5-4.51 4.5 6h-14l3.5-4.5z"/>
      </svg>
      Galerie
    </button>
    <button class="source-selection-cancel" onclick="hideSourceSelection()">Annuler</button>
  </div>

  <div id="popup" class="modal">
    <div class="modal-content">
      <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">Souhaitez-vous afficher ce m√©dia dans la galerie ?</p>
      <div class="loader" id="loader"></div>
      <div class="modal-buttons" id="modalButtons">
        <button class="public-btn" onclick="sendMedia(true)">üì¢ Afficher en public</button>
        <button class="private-btn" onclick="sendMedia(false)">üîí Uniquement pour les mari√©s</button>
      </div>
    </div>
  </div>

  <div id="gallery">
    <h2>Galerie des invit√©s</h2>
    <div id="drive-gallery"></div>
  </div>

  <div class="lightbox" id="lightbox" onclick="closeLightbox(event)">
    <div id="lightbox-content"></div>
    <button class="close-btn" onclick="closeLightbox({target:document.getElementById('lightbox')});">&times;</button>
    <button class="download-btn" id="downloadBtn" onclick="downloadMedia()">
      <img src="telecharger-un-fichier.png" alt="T√©l√©charger"/>
    </button>
    <button class="lightbox-nav prev" onclick="navigateGallery(-1)">‚Äπ</button>
    <button class="lightbox-nav next" onclick="navigateGallery(1)">‚Ä∫</button>
  </div>

  <script>
    const folderId = "1J4fn2yvUhe0MEZY6KZtDb_2PJutP7FL7";
    const apiKey = "AIzaSyAKdgvWZ4dX7oS0btyCHtMSS-bgErTtnhY";
    let galleryFiles = [];
    let currentImageIndex = 0;

    async function loadGallery() {
      const endpoint = `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+(mimeType+contains+'image/'+or+mimeType+contains+'video/')&key=${apiKey}&fields=files(id,name,mimeType,thumbnailLink,webContentLink)`;
      const res = await fetch(endpoint);
      const data = await res.json();
      const container = document.getElementById("drive-gallery");

      galleryFiles = data.files;
      container.innerHTML = "";
      
      data.files.forEach((file, index) => {
        const thumb = file.thumbnailLink?.replace("=s220", "=s600") || "";
        const webLink = file.webContentLink;

        const wrapper = document.createElement("div");
        const element = file.mimeType.includes("video")
          ? document.createElement("video")
          : document.createElement("img");

        element.src = file.mimeType.includes("video")
          ? `https://drive.google.com/uc?export=download&id=${file.id}`
          : thumb;
        element.alt = file.name;
        element.setAttribute("data-full", webLink);
        element.onclick = () => openLightbox(file.mimeType, element.src, webLink, index);

        wrapper.appendChild(element);
        container.appendChild(wrapper);
      });
    }

    function openLightbox(type, src, downloadLink, index) {
      currentImageIndex = index;
      const content = document.getElementById("lightbox-content");
      const lightbox = document.getElementById("lightbox");
      const btn = document.getElementById("downloadBtn");

      content.innerHTML = "";

      const el = document.createElement(type.includes("video") ? "video" : "img");
      el.src = src;
      if (type.includes("video")) el.controls = true;
      content.appendChild(el);

      btn.setAttribute("data-src", downloadLink);
      document.body.classList.add("lightbox-open");
      lightbox.style.display = "flex";
      
      updateNavigationButtons();
    }

    function navigateGallery(direction) {
      currentImageIndex += direction;
      
      if (currentImageIndex < 0) currentImageIndex = galleryFiles.length - 1;
      if (currentImageIndex >= galleryFiles.length) currentImageIndex = 0;
      
      const file = galleryFiles[currentImageIndex];
      const thumb = file.thumbnailLink?.replace("=s220", "=s600") || "";
      const src = file.mimeType.includes("video")
        ? `https://drive.google.com/uc?export=download&id=${file.id}`
        : thumb;
      
      openLightbox(file.mimeType, src, file.webContentLink, currentImageIndex);
    }

    function updateNavigationButtons() {
      const prevBtn = document.querySelector('.lightbox-nav.prev');
      const nextBtn = document.querySelector('.lightbox-nav.next');
      
      prevBtn.style.display = galleryFiles.length > 1 ? 'block' : 'none';
      nextBtn.style.display = galleryFiles.length > 1 ? 'block' : 'none';
    }

    function downloadMedia() {
      const src = document.getElementById("downloadBtn").getAttribute("data-src");
      const a = document.createElement("a");
      a.href = src;
      a.download = "";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function closeLightbox(event) {
      if (event.target.id === "lightbox" || event.key === "Escape" || event.target.classList.contains('close-btn')) {
        document.getElementById("lightbox").style.display = "none";
        document.body.classList.remove("lightbox-open");
      }
    }

    document.addEventListener("keydown", closeLightbox);
    window.addEventListener("DOMContentLoaded", loadGallery);

    // D√©tection de l'OS et gestion adaptative
    function isIOS() {
      return /iPhone|iPad|iPod/i.test(navigator.userAgent) || 
             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }

    function openMediaSelector() {
      if (isIOS()) {
        // Sur iOS, ouvrir directement l'input qui affichera le menu natif
        document.getElementById('mediaInput').click();
      } else {
        // Sur Android et autres, afficher notre menu personnalis√©
        showSourceSelection();
      }
    }

    function showSourceSelection() {
      document.getElementById('sourceSelection').style.display = 'block';
      document.querySelector('.source-selection-backdrop').style.display = 'block';
    }

    function hideSourceSelection() {
      document.getElementById('sourceSelection').style.display = 'none';
      document.querySelector('.source-selection-backdrop').style.display = 'none';
    }

    function selectCamera() {
      hideSourceSelection();
      document.getElementById('cameraInput').click();
    }

    function selectGallery() {
      hideSourceSelection();
      document.getElementById('mediaInput').click();
    }

    let selectedFile = null;
    function handleFile(file) {
      if (file) {
        selectedFile = file;
        document.getElementById('popup').style.display = 'flex';
      }
    }

    async function sendMedia(isPublic) {
      // Afficher le loader avec message de transfert
      const modalContent = document.querySelector('.modal-content');
      modalContent.innerHTML = `
        <div style="padding: 2rem;">
          <p style="font-size: 1.2rem; margin-bottom: 1.5rem;">Transfert en cours...</p>
          <div class="loader" style="display: block;"></div>
        </div>
      `;
      
      const reader = new FileReader();
      reader.onloadend = async () => {
        try {
          const base64 = reader.result.split(',')[1];
          const fd = new URLSearchParams();
          fd.append('fileContent', encodeURIComponent(base64));
          fd.append('fileType', selectedFile.type);
          fd.append('fileName', selectedFile.name);
          fd.append('public', isPublic ? 'true' : 'false');
          
          const res = await fetch(
            'https://script.google.com/macros/s/AKfycbx1tKY8CNcb1snBapGEbN0lQOkJF5-QUG299dYwWSEyTIOIuoqTcqe-22a5Q-VByQo0/exec', 
            { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: fd }
          );
          
          const result = await res.text();
          
          // Afficher le message de succ√®s avec style
          modalContent.innerHTML = `
            <div style="padding: 2rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
              <h3 style="color: #4CAF50; margin-bottom: 1rem;">Merci !</h3>
              <p style="font-size: 1.1rem;">${result}</p>
            </div>
          `;
          
          // Fermer automatiquement apr√®s 3 secondes
          setTimeout(() => {
            document.getElementById('popup').style.display = 'none';
            // R√©initialiser le contenu pour la prochaine fois
            modalContent.innerHTML = `
              <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">Souhaitez-vous afficher ce m√©dia dans la galerie ?</p>
              <div class="loader" id="loader"></div>
              <div class="modal-buttons" id="modalButtons">
                <button class="public-btn" onclick="sendMedia(true)">üì¢ Afficher en public</button>
                <button class="private-btn" onclick="sendMedia(false)">üîí Uniquement pour les mari√©s</button>
              </div>
            `;
            
            // Recharger la galerie si le m√©dia √©tait public
            if (isPublic) {
              loadGallery();
            }
          }, 3000);
          
        } catch (error) {
          modalContent.innerHTML = `
            <div style="padding: 2rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
              <h3 style="color: #f44336; margin-bottom: 1rem;">Erreur</h3>
              <p style="font-size: 1.1rem;">Une erreur est survenue. Veuillez r√©essayer.</p>
            </div>
          `;
          
          setTimeout(() => {
            document.getElementById('popup').style.display = 'none';
            // R√©initialiser le contenu
            modalContent.innerHTML = `
              <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">Souhaitez-vous afficher ce m√©dia dans la galerie ?</p>
              <div class="loader" id="loader"></div>
              <div class="modal-buttons" id="modalButtons">
                <button class="public-btn" onclick="sendMedia(true)">üì¢ Afficher en public</button>
                <button class="private-btn" onclick="sendMedia(false)">üîí Uniquement pour les mari√©s</button>
              </div>
            `;
          }, 3000);
        }
      };
      reader.readAsDataURL(selectedFile);
    }
  </script>

</body>
</html>
